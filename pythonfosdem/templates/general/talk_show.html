{% extends 'layout.html' %}

{% block content %}
<div class="page-header">
    <h2>{{ _('Talk') }}</h2>
</div>
<div class='row'>
    <div class='span12'>
        <table class='table table-striped table-condensed table-bordered'>
            <tr>
                <th>Title</th>
                <td>{{ talk.name }}</td>
            </tr>
            <tr>
                <th>Speaker</th>
                <td>{{ talk.user.name }}</td>
            </tr>
            <tr>
                <th>Description</th>
                <td>{{ talk.description }}</td>
            </tr>
            <tr>
                <th>Site</th>
                <td>{{ talk.site_url }}</td>
            </tr>
            <tr>
                <th>Twitter</th>
                <td>{{ talk.twitter }}</td>
            </tr>
            <tr>
                <th>State</th>
                <td>{{ talk.state }}</td>
            </tr>
        </table>

        {% if current_user.has_role('jury_member') %}

            {% if talk.current_user_vote.value == 1 %}
                {% set btns = ('btn-success', 'btn-inverse') %}
                {% set votes = ('none', '') %}
            {% elif talk.current_user_vote.value == -1 %}
                {% set btns = ('btn-inverse', 'btn-danger') %}
                {% set votes = ('', 'none') %}
            {% else %}
                {% set btns = ('', '') %}
                {% set votes = ('up', 'down') %}
            {% endif %}


        <div class="btn-group" id="btn-group">
            <a href="#"
                data-model-id="{{ talk.id }}" data-vote='{{ votes[0] }}'
                class="on-vote vote-up btn {{ btns[0] }} btn-small"><i class="icon-arrow-up"></i> {{ _('Vote Up') }}</a>

            <a href="#"
                data-model-id="{{ talk.id }}" data-vote='{{ votes[1] }}'
                class="on-vote vote-down btn {{ btns[1] }} btn-small">{{ _('Vote Down') }} <i class="icon-arrow-down"></i></a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{%- block final_js %}
    {{ super() }}


    <script>
    $(function() {
        var pythonfosdem = {
            ajax_post: function(url, params, on_success) {
                var _callback = function(response) {
                    if (response.success) {
                        if (response.redirect_url) {
                            window.location.href = response.redirect_url;
                        }
                        else if (response.reload) {
                            window.location.reload();
                        }
                        else if (on_success) {
                            return on_success(response);
                        }
                    } else {
                        // Error handling
                    }
                };
                $.post(url, params, _callback, 'json');
            }
        };

        $('a.on-vote').each(function(index, item) {
            $(item).on('click', function(event) {
                event.preventDefault();
                var self = $(this),
                    record_id = $(this).data('model-id'),
                    vote = $(this).data('vote');

                if (vote === '') {
                    return;
                }

                var classes = {
                    'none': ['', ''],
                    'up': ['btn-inverse', 'btn-success'],
                    'down': ['btn-inverse', 'btn-danger'],
                }[vote];

                var params = {
                    record_id: record_id,
                    vote: vote,
                };

                pythonfosdem.ajax_post('{{ url_for("general.talk_vote") }}', params, function(response) {
                    console.log(response);
                    $('a.on-vote').removeClass('btn-success btn-danger btn-inverse').not(self).addClass(classes[0]).data('vote', '');
                    self.addClass(classes[1]).data('vote', 'none');
                    if (vote === 'none') {
                        $('a.on-vote.vote-up').data('vote', 'up');
                        $('a.on-vote.vote-down').data('vote', 'down');
                    }
                });
            });

        });
    });
    </script>

{%- endblock %}
